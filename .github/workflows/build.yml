name: Build Reaper Toolbox

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 12 * * 0'  # Weekly on Sunday at 12:00 UTC
  workflow_dispatch:  # Allow manual trigger

# "contents: write" allows the action to create a release
# this is required by the release step, which uses "gh release create"
permissions:
  contents: write

# improve CI concurrency by automatically cancelling outdated jobs
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build:

    # https://github.com/actions/runner-images
    # Installed Software: https://github.com/actions/runner-images/blob/main/images/windows/Windows2025-Readme.md
    runs-on: windows-2025

    steps:
      - name: ü§ò Checkout Code
        uses: actions/checkout@v5 # https://github.com/actions/checkout
        with:
          fetch-depth: 1

      - name: Set Version Number vars
        shell: cmd
        run: |
          FOR /F "tokens=* USEBACKQ" %%F IN (`git rev-parse --short HEAD`) DO (
            echo GIT_SHORT_HASH=%%F>>%GITHUB_ENV%
            set GIT_SHORT_HASH=%%F
          )
          echo APP_BUILD_VERSION=dev-%GIT_SHORT_HASH%>>%GITHUB_ENV%

      - name: ‚Ñπ Show APP_BUILD_VERSION
        shell: bash
        run: |
          echo "Git hash: $GIT_SHORT_HASH"
          echo "App version: $APP_BUILD_VERSION"

      - name: üîΩ Download Components
        run: build-tools\php\php.exe build-tools\build.php

      - name: ‚Ñπ List Downloads
        shell: bash
        run: |
          ls -lhs downloads
          ls -lhs build-tools
          ls -lhs .

      - name: üôè Compile Installer
        shell: cmd
        run: |
          echo Building version %APP_BUILD_VERSION%
          build-tools\InnoSetup6\iscc.exe /DAPP_VERSION=%APP_BUILD_VERSION% installer\Reaper-Toolbox.iss

    #   - name: ‚úÖ Run Installation Test
    #     shell: pwsh
    #     env:
    #        INSTALL_DIR: ${{ github.workspace }}\install
    #     run: |
    #       $installerPath = Join-Path $env:GITHUB_WORKSPACE "release\Reaper-Toolbox-v1.0.0-dev-$env:GIT_SHORT_HASH-x64.exe"
    #       $installDir = $env:INSTALL_DIR
    #       Write-Host "Installing to $installDir"
    #       $arguments = @(
    #           "/SILENT",
    #           "/VERYSILENT",
    #           "/SUPPRESSMSGBOXES",
    #           "/NORESTART",
    #           "/NOCANCEL",
    #           "/SP-",
    #           "/DIR=`"$installDir`""
    #       )
    #       $process = Start-Process -FilePath $installerPath -ArgumentList $arguments -PassThru -NoNewWindow
    #       if (-not $process.WaitForExit(180000)) {  # 3 min timeout
    #           Write-Error "Installer timed out!"
    #           Stop-Process -Id $process.Id -Force
    #           exit 1
    #       }

      - name: ‚úÖ Run Installation Test
        shell: cmd
        env:
           INSTALL_DIR: "${{ github.workspace }}\\install"
        run: |
          echo Installing to %INSTALL_DIR%
          test-installation.bat

      - name: List Install Dir
        shell: bash
        env:
            INSTALL_DIR: "${{ github.workspace }}\\install"
        run: |
            ls -lhs "$INSTALL_DIR"

      - name: üì¢ Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create v${{ github.run_number }}_${{ env.GIT_SHORT_HASH }} release/Reaper-Toolbox*.exe \
            --title "Reaper-Toolbox v${{ github.run_number }}_${{ env.GIT_SHORT_HASH }}" \
            --notes-file release_notes.md \
            --generate-notes
