# Azure Pipelines

name: $(Build.DefinitionName)_$(SourceBranchName)_$(Date:yyMMdd).$(Rev:r)

# run pipeline build, when master branch changes
trigger:
- master

# don't run against pull-requests
pr: none

pool:
  vmImage: 'windows-latest'

steps:
  - task: CmdLine@2
    displayName: 'Set Version Number vars'
    inputs:
      script: |
        SETLOCAL EnableDelayedExpansion
        FOR /F "tokens=* USEBACKQ" %%F IN (`git rev-parse --short HEAD`) DO (
            @echo ##vso[task.setvariable variable=GIT_COMMIT_HASH_SHORT;]%%F
        )
        echo '##vso[task.setvariable variable=GIT_BRANCH]$(Build.SourceBranchName)'
      workingDirectory: '$(Build.SourcesDirectory)'
  - bash: |
       echo $GIT_COMMIT_HASH_SHORT
       echo $GIT_BRANCH
       echo '##vso[task.setvariable variable=APP_BUILD_VERSION;is_output=true]dev-$GIT_COMMIT_HASH_SHORT-$(Date:yyMMdd)$(Rev:.r)'
    displayName: Set APP_BUILD_Version

  - script: build-tools\php\php.exe build-tools\build.php
    displayName: Download Components

  - script: ls -lhs downloads
    displayName: "List Downloads"

  - script: build-tools\InnoSetup6\iscc.exe /DAPP_VERSION=$(APP_BUILD_VERSION) installer\Reaper-Toolbox.iss
    displayName: Compile Installer

  - task: GitHubRelease@1
    inputs:
      githubConnection: 'github.com_jakoch'
      repositoryName: '$(Build.Repository.Name)'
      action: 'create'
      target: '$(Build.SourceVersion)'
      tagSource: 'gitTag'
      releaseNotesFilePath: '$(Build.ArtifactStagingDirectory)/release-notes.txt'
      assets: '$(Build.ArtifactStagingDirectory)/Reaper-Toolbox*.exe'
      changeLogCompareToRelease: 'lastFullRelease'
      changeLogType: 'commitBased'
    displayName: Add Github Release
      
schedules:
 - cron: "0 12 * * 0"
   displayName: Build Weekly@Sunday
   branches:
    include:
    - master
   always: true
 