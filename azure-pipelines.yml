# Azure Pipelines

name: $(Build.DefinitionName)_$(SourceBranchName)_$(Date:yyMMdd).$(Rev:r)

# run pipeline build, when master branch changes
trigger:
- master

# don't run against pull-requests
pr: none

pool:
  vmImage: 'windows-latest'

# can not get the git commit hash here, why?
#variables:
# APP_BUILD_VERSION: '1.0.0-dev-$(Build.BuildNumber)-$(Date:yyMMdd)$(Rev:.r)'

steps:
  - bash: |
      gitMessage=$(git log --format='%s' -1)
      echo "##vso[task.setvariable variable=commitMessage;isOutput=true]$gitMessage" 
      COMMIT_HASH=$(git rev-parse --short HEAD)
      echo '##vso[task.setvariable variable=GIT_COMMIT_SHA]$COMMIT_HASH'
      echo '##vso[task.setvariable variable=GIT_BRANCH]$(Build.SourceBranchName)'
    displayName: 'Configure Environment Variables'
  - script: |
      echo $(commitMessage)
      echo $(GIT_COMMIT_SHA)
      echo $(GIT_BRANCH)
    displayName: 'Echo Commit SHA and Branch'

  #- bash: |
  #    build_version=$(1.0.0-dev)-$(gitCommit)-$(Date:yyMMdd)$(Rev:.r)
  #    echo $(build_version)
  #    echo "##vso[task.setvariable variable=APP_BUILD_VERSION]$build_version"
  #    echo $(APP_BUILD_VERSION)
  #  displayName: Set App Build Version

  #- script: build-tools\php\php.exe build-tools\build.php
  #  displayName: Download Components

  #- script: ls -lhs downloads
  #  displayName: "List Downloads"

  #- script: build-tools\InnoSetup6\iscc.exe /DAPP_VERSION=$(APP_BUILD_VERSION) installer\Reaper-Toolbox.iss
  #  displayName: Compile Installer

  #- task: GithubRelease@0
  #  displayName: Add GithubRelease (Windows)

schedules:
 - cron: "0 12 * * 0"
   displayName: Build Weekly@Sunday
   branches:
    include:
    - master
   always: true
 