# Azure Pipelines

name: $(Build.DefinitionName)_$(SourceBranchName)_$(Date:yyMMdd).$(Rev:r)

# run pipeline build, when master branch changes
trigger:
- master

# don't run against pull-requests
pr: none

pool:
  vmImage: 'windows-latest'

# can not get the git commit hash here, why?
variables:
 #APP_BUILD_VERSION: '1.0.0-dev-$(Build.BuildNumber)-$(Date:yyMMdd)$(Rev:.r)'
 APP_BUILD_VERSION: '1.0.0-dev'

steps:
# WHAT THE FUCK! how to get the short commit hash???
# build_version=$(1.0.0-dev)-$(gitCommit)-$(Date:yyMMdd)$(Rev:.r)
  #- bash: |
  #    latest_commit=$(git rev-parse --short HEAD)
  #    echo '##vso[task.setvariable variable=GIT_COMMIT_SHA]$latest_commit'
  #    echo '##vso[task.setvariable variable=GIT_BRANCH]$(Build.SourceBranchName)'
  #  displayName: 'Configure Environment Variables'
  #- script: |
  #    echo $(GIT_COMMIT_SHA)
  #    echo $(GIT_BRANCH)
  #  displayName: 'Echo Commit SHA and Branch'

  - task: CmdLine@2
    displayName: 'Set Version Number vars'
    inputs:
      script: |
        SETLOCAL EnableDelayedExpansion
        FOR /F "tokens=* USEBACKQ" %%F IN (`git rev-parse --short HEAD`) DO (
            @echo ##vso[task.setvariable variable=GIT_COMMIT_HASH_SHORT;]%%F
        )
      workingDirectory: '$(Build.SourcesDirectory)'
  - bash: |
       echo $GIT_COMMIT_HASH_SHORT
       echo $(GIT_COMMIT_HASH_SHORT)
       echo ##vso[task.setvariable variable=APP_BUILD_VERSION;]$APP_BUILD_VERSION-$GIT_COMMIT_HASH_SHORT-$(Date:yyMMdd)$(Rev:.r)
    displayName: Set APP_BUILD_Version

  - script: build-tools\php\php.exe build-tools\build.php
    displayName: Download Components

  - script: ls -lhs downloads
    displayName: "List Downloads"

  - script: build-tools\InnoSetup6\iscc.exe /DAPP_VERSION=$(APP_BUILD_VERSION) installer\Reaper-Toolbox.iss
    displayName: Compile Installer

  - task: GitHubRelease@1
    inputs:
      githubConnection: 'github.com_jakoch'
      repositoryName: '$(Build.Repository.Name)'
      action: 'create'
      target: '$(Build.SourceVersion)'
      tagSource: 'gitTag'
      releaseNotesFilePath: '$(Build.ArtifactStagingDirectory)/release-notes.txt'
      assets: '$(Build.ArtifactStagingDirectory)/Reaper-Toolbox*.exe'
      changeLogCompareToRelease: 'lastFullRelease'
      changeLogType: 'commitBased'
    displayName: Add Github Release
      
schedules:
 - cron: "0 12 * * 0"
   displayName: Build Weekly@Sunday
   branches:
    include:
    - master
   always: true
 