# Azure Pipelines

name: "Reaper-Toolbox_v$(Date:yyMMdd)_r$(Rev:r)"

# run pipeline build, when main branch changes
trigger:
- main

# don't run against pull-requests
pr: none

pool:
  vmImage: 'windows-latest'

variables:
  _RELEASE_TAG: "v$(Date:yyMMdd)_r$(Rev:r)"
  _RELEASE_TITLE: "Reaper Toolbox v$(Date:yyMMdd)_r$(Rev:r)"

steps:
  - task: CmdLine@2
    displayName: 'Set Version Number vars'
    inputs:
      script: |
        SETLOCAL EnableDelayedExpansion
        FOR /F "tokens=* USEBACKQ" %%F IN (`git rev-parse --short HEAD`) DO (
            @echo ##vso[task.setvariable variable=GIT_COMMIT_HASH_SHORT;]%%F
        )
        echo ##vso[task.setvariable variable=GIT_BRANCH]$(Build.SourceBranchName)
        echo ##vso[task.setvariable variable=APP_BUILD_VERSION]dev-$(GIT_COMMIT_HASH_SHORT)
      workingDirectory: '$(Build.SourcesDirectory)'
      
  - bash: |
       echo $GIT_COMMIT_HASH_SHORT
       echo $GIT_BRANCH
       echo $APP_BUILD_VERSION
    displayName: Show APP_BUILD_VERSION

  - script: build-tools\php\php.exe build-tools\build.php
    displayName: üîΩ Download Components

  - script: |
      ls -lhs downloads
      ls -lhs build-tools
      ls -lhs .
    displayName: ‚Ñπ List Downloads

  - script: build-tools\InnoSetup6\iscc.exe /DAPP_VERSION=$(APP_BUILD_VERSION) installer\Reaper-Toolbox.iss
    displayName: üôè Compile Installer
  
  # https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/github-release-v1
  - task: GitHubRelease@1
    displayName: üì¢ Add Github Release
    inputs:
      githubConnection: 'github.com_jakoch'
      repositoryName: '$(Build.Repository.Name)'
      action: 'create'
      tag: '$(_RELEASE_TAG)'
      title: '$(_RELEASE_TITLE)'
      target: '$(Build.SourceVersion)'
      tagSource: 'userSpecifiedTag'
      releaseNotesFilePath: 'release_notes.md'
      assets: 'release/Reaper-Toolbox*.exe'
      changeLogCompareToRelease: 'lastFullRelease'
      changeLogType: 'commitBased'
      
schedules:
 - cron: "0 12 * * 0"
   displayName: ‚öô Build Weekly@Sunday
   branches:
    include:
    - main
   always: true 
